<hr>
<p>title: 事件循环机制<br>excerpt: 事件循环机制<br>toc: true<br>tag: ‘JavaScript’<br>categories:</p>
<ul>
<li>前端</li>
<li>JavaScript</li>
</ul>
<hr>
<h2 id="1-JavaScript执行机制"><a href="#1-JavaScript执行机制" class="headerlink" title="1.JavaScript执行机制"></a>1.JavaScript执行机制</h2><ul>
<li>同步：在执行到同步代码时，会按照顺序执行直接输出</li>
<li>异步：在执行到异步代码时，会将异步代码的回调函数存入事件队列中，等所有同步代码执行完成后再执行异步代码</li>
</ul>
<pre><code class="javascript">console.log(1) // 同步
setTimeout(() =&gt; {
  console.log(2) // 异步
}, 2000); // 注意延迟的时间
console.log(3) // 同步
setTimeout(() =&gt; {
  console.log(4) // 异步
}, 0);
console.log(5) // 同步

// 输出 ： 1 3 5 4 2
</code></pre>
<h2 id="2-宏任务-amp-amp-微任务"><a href="#2-宏任务-amp-amp-微任务" class="headerlink" title="2.宏任务&amp;&amp;微任务"></a>2.宏任务&amp;&amp;微任务</h2><p>异步任务分为<code>宏任务</code>和<code>微任务</code>，<strong>微任务执行时机先于宏任务</strong></p>
<ul>
<li>宏任务</li>
</ul>
<table>
<thead>
<tr>
<th>#</th>
<th>浏览器</th>
<th>Node</th>
</tr>
</thead>
<tbody><tr>
<td><strong>I/O</strong></td>
<td>✅</td>
<td>✅</td>
</tr>
<tr>
<td><strong>setTimeout</strong></td>
<td>✅</td>
<td>✅</td>
</tr>
<tr>
<td><strong>setInterval</strong></td>
<td>✅</td>
<td>✅</td>
</tr>
<tr>
<td><strong>setImmediate</strong></td>
<td>❌</td>
<td>✅</td>
</tr>
<tr>
<td><strong>requestAnimationFrame</strong></td>
<td>✅</td>
<td>❌</td>
</tr>
</tbody></table>
<ul>
<li>微任务</li>
</ul>
<table>
<thead>
<tr>
<th>#</th>
<th>浏览器</th>
<th>Node</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Promise.prototype.then catch finally</strong></td>
<td>✅</td>
<td>✅</td>
</tr>
<tr>
<td><strong>process.nextTick</strong></td>
<td>❌</td>
<td>✅</td>
</tr>
<tr>
<td><strong>MutationObserver</strong></td>
<td>✅</td>
<td>❌</td>
</tr>
</tbody></table>
<ul>
<li>执行流程</li>
</ul>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/df0c109150d34369913d7039a6f41370~tplv-k3u1fbpfcp-watermark.awebp" alt="1"></p>
<h2 id="3-例子"><a href="#3-例子" class="headerlink" title="3.例子"></a>3.例子</h2><pre><code class="js">console.log(1) // 同步
setTimeout(() =&gt; {
  console.log(2) // 异步：宏任务
});
console.log(3) // 同步
Promise.resolve().then(()=&gt;{ // 异步：微任务
  console.log(4)
})
console.log(5) // 同步
// 1 3 5 4 2
</code></pre>
<h3 id="例1"><a href="#例1" class="headerlink" title="例1"></a>例1</h3><pre><code class="js">console.log(1)
setTimeout(() =&gt; {
  console.log(2)
  Promise.resolve().then(() =&gt; {
    console.log(3)
  })
});
console.log(4)
new Promise((resolve,reject) =&gt; {
  console.log(5)
  resolve()
}).then(() =&gt; {
  console.log(6)
  setTimeout(() =&gt; {
    console.log(7)
  })
})
console.log(8)

// 1 4 5 8 6 2 3 7
</code></pre>
<h3 id="例2"><a href="#例2" class="headerlink" title="例2"></a>例2</h3><pre><code class="js">setTimeout(() =&gt; {
  console.log(1)
}, 0)
console.log(2)
const p = new Promise((resolve) =&gt; {
  console.log(3)
  resolve()
}).then(() =&gt; {
  console.log(4)
}).then(() =&gt; {
  console.log(5)
})
console.log(6)

// 2 3 6 4 5 1
</code></pre>
<p>遇到<code>Promise.then.then</code>这种时，如果有点懵逼的同学，可以转换一下</p>
<pre><code class="js">setTimeout(() =&gt; { // 异步：宏任务 setTimeout
  console.log(1)
}, 0)
console.log(2) // 同步
const p = new Promise((resolve) =&gt; { // p 是 then1 执行返回的新 Promise
  console.log(3) // 同步
  resolve()
}).then(() =&gt; { // 异步：微任务 then1
  console.log(4)
  // 拿着 p 重新 then
  p.then(() =&gt; { // 异步：微任务 then2
    console.log(5)
  })
})
console.log(6) // 同步 6
// 2 3 6 4 5 1
</code></pre>
<h3 id="例3"><a href="#例3" class="headerlink" title="例3"></a>例3</h3><pre><code class="js">new Promise((resolve,reject)=&gt;{
  console.log(1)
  resolve()
}).then(()=&gt;{
  console.log(2)
  new Promise((resolve,reject)=&gt;{
      console.log(3)
      resolve()
  }).then(()=&gt;{
      console.log(4)
  }).then(()=&gt;{
      console.log(5)
  })
}).then(()=&gt;{
  console.log(6)
})

// 转换后的代码
const p1 = new Promise((resolve,reject)=&gt;{
  console.log(1)
  resolve()
}).then(()=&gt;{
      console.log(2)
      const p2 = new Promise((resolve,reject)=&gt;{
          console.log(3)
          resolve()
      }).then(()=&gt;{
          console.log(4)
          p2.then(()=&gt;{
              console.log(5)
          })
      })
      p1.then(()=&gt;{
      console.log(6)
    })
})
// 1 2 3 4 6 5
</code></pre>
<h3 id="例4"><a href="#例4" class="headerlink" title="例4"></a>例4</h3><pre><code class="js">new Promise((resolve, reject) =&gt; {
  console.log(1)
  resolve()
}).then(() =&gt; {
  console.log(2)
  // 多了个return
  return new Promise((resolve, reject) =&gt; {
    console.log(3)
    resolve()
  }).then(() =&gt; {
    console.log(4)
  }).then(() =&gt; { // 相当于return了这个then的执行返回Promise
    console.log(5)
  })
}).then(() =&gt; {
  console.log(6)
})

// 1 2 3 4 5 6
</code></pre>
<h3 id="例5"><a href="#例5" class="headerlink" title="例5"></a>例5</h3><pre><code class="js">new Promise((resolve, reject) =&gt; {
  console.log(1)
  resolve()
}).then(() =&gt; {
  console.log(2)
  new Promise((resolve, reject) =&gt; {
    console.log(3)
    resolve()
  }).then(() =&gt; {
    console.log(4)
  }).then(() =&gt; {
    console.log(5)
  })
}).then(() =&gt; {
  console.log(6)
})

new Promise((resolve, reject) =&gt; {
  console.log(7)
  resolve()
}).then(() =&gt; {
  console.log(8)
})

// 1 7 2 3 8 4 6 5
</code></pre>
<h3 id="例6"><a href="#例6" class="headerlink" title="例6"></a>例6</h3><pre><code class="js">async function async1() {
  console.log(1);
  await async2();
  console.log(2);
}
async function async2() {
  console.log(3);
}
console.log(4);
setTimeout(function () {
  console.log(5);
});
async1()
new Promise(function (resolve, reject) {
  console.log(6);
  resolve();
}).then(function () {
  console.log(7);
});
console.log(8);
</code></pre>
<ul>
<li>转换后的代码</li>
</ul>
<pre><code class="js">console.log(4);

setTimeout(function () {
  console.log(5);
});

console.log(1);
new Promise((resolve, reject) =&gt; {
    console.log(3);
}).then(() =&gt; {
    console.log(2);
})

new Promise(function (resolve, reject) {
  console.log(6);
  resolve();
}).then(function () {
  console.log(7);
});
console.log(8);

// 4 1 3 6 8 2 7 5
</code></pre>
<h2 id="例7"><a href="#例7" class="headerlink" title="例7"></a>例7</h2><pre><code class="js">async function async1() {
  console.log(1);
  await async2();
  console.log(2);
}
async function async2() {
  console.log(3);
}

new Promise((resolve, reject) =&gt; {
  setTimeout(() =&gt; {
    resolve()
    console.log(4)
  }, 1000);
}).then(() =&gt; {
  console.log(5)
  new Promise((resolve, reject) =&gt; {
    setTimeout(() =&gt; {
      async1()
      resolve()
      console.log(6)
    }, 1000)
  }).then(() =&gt; {
    console.log(7)
  }).then(() =&gt; {
    console.log(8)
  })
}).then(() =&gt; {
  console.log(9)
})
new Promise((resolve, reject) =&gt; {
  console.log(10)
  setTimeout(() =&gt; {
    resolve()
    console.log(11)
  }, 3000);
}).then(() =&gt; {
  console.log(12)
})
</code></pre>
<ul>
<li>转换后</li>
</ul>
<pre><code class="js">new Promise((resolve, reject) =&gt; {
  setTimeout(() =&gt; {
    resolve()
    console.log(4)
  }, 1000);
}).then(() =&gt; {
  console.log(5)
  new Promise((resolve, reject) =&gt; {
    setTimeout(() =&gt; {
      console.log(1);
      new Promise((resolve, reject) =&gt; {
          console.log(3);
          resolve();
      }).then(() =&gt; {
          console.log(2);
      })
      resolve()
      console.log(6)
    }, 1000)
  }).then(() =&gt; {
    console.log(7)
  }).then(() =&gt; {
    console.log(8)
  })
}).then(() =&gt; {
  console.log(9)
})

new Promise((resolve, reject) =&gt; {
  console.log(10)
  setTimeout(() =&gt; {
    resolve()
    console.log(11)
  }, 3000);
}).then(() =&gt; {
  console.log(12)
})

// 10 4 5 9 1 3 6 2 7 8 11 12
</code></pre>
<h3 id="例8"><a href="#例8" class="headerlink" title="例8"></a>例8</h3><pre><code class="js">async function async1() {
  console.log(&#39;async1 start&#39;)
  await async2()
  console.log(&#39;async1 end&#39;)
}

async function async2() {
  console.log(&#39;async start&#39;)
  return new Promise((resolve, reject) =&gt; {
    resolve()
    console.log(&#39;async2 promise&#39;)
  })
}

console.log(&#39;script start&#39;)
setTimeout(() =&gt; {
  console.log(&#39;setTimeout&#39;)
}, 0);

async1()

new Promise((resolve) =&gt; {
  console.log(&#39;promise1&#39;)
  resolve()
}).then(() =&gt; {
  console.log(&#39;promise2&#39;)
}).then(() =&gt; {
  console.log(&#39;promise3&#39;)
})
console.log(&#39;script end&#39;)
</code></pre>
<ul>
<li>转换后</li>
</ul>
<pre><code class="js">console.log(&#39;script start&#39;)

setTimeout(() =&gt; {
  console.log(&#39;setTimeout&#39;)
}, 0);

console.log(&#39;async1 start&#39;)

new Promise((resolve,reject) =&gt; {
  console.log(&#39;async start&#39;)
  return new Promise((resolve, reject) =&gt; {
    resolve()
    console.log(&#39;async2 promise&#39;)
  })
}).then(() =&gt; {
    console.log(&#39;async1 end&#39;)
})

new Promise((resolve) =&gt; {
  console.log(&#39;promise1&#39;)
  resolve()
}).then(() =&gt; {
  console.log(&#39;promise2&#39;)
}).then(() =&gt; {
  console.log(&#39;promise3&#39;)
})
console.log(&#39;script end&#39;)

// script start
// async1 start
// async start
// async2 promise
// promise1
// script end
// promise2
// promise3
// async1 end
// setTimeout
</code></pre>
<pre><code class="js">Promise.resolve().then(() =&gt; {
    console.log(0);
    return Promise.resolve(4);
}).then((res) =&gt; {
    console.log(res)
})

Promise.resolve().then(() =&gt; {
    console.log(1);
}).then(() =&gt; {
    console.log(2);
}).then(() =&gt; {
    console.log(3);
}).then(() =&gt; {
    console.log(5);
}).then(() =&gt;{
    console.log(6);
})
</code></pre>
